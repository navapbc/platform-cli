#!/usr/bin/env bash
set -euo pipefail

# TODO: resolve paths to absolute, and mount them in same location in container,
# some messages use expected paths

docker_flags=("-v $HOME/.ssh:/home/root/.ssh:ro")
for arg in "$@"; do
  shift

  if [[ "$arg" =~ --template-uri.* ]]; then
      if [[ "$arg" == *"="* ]]; then
        template_value="${arg#*=}"
      else
        template_value="$1"
        shift # skip over --template-uri
      fi

      # does it look like a local path?
      if [[ "${template_value}" =~ ^[\./] ]]; then
        docker_flags+=("-v ${template_value}:/template-dir")
        set -- "$@" "--template-uri=/template-dir"
        continue
      fi
  fi

  set -- "$@" "$arg"
done

# get last argument
last_arg="${@: -1}"
# set argument list to current minus the last element
set -- "${@:1:$(($#-1))}"

docker_flags+=("-v ${last_arg}:/project-dir")
set -- "$@" "/project-dir"


docker run --rm ${docker_flags[@]} platform "$@"
