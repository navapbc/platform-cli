#!/usr/bin/env bash
set -euo pipefail

processed_args=()
# TODO: correctly mount host SSH/other necessary stuff so if/when the tools
# supports fetching remote repos, things work
docker_flags=("-v=$HOME/.ssh:/home/root/.ssh:ro")
for ((i=1;i<=$#;i++))
do
  eval "arg=\${$i}"

  if [[ "${arg}" =~ --template-uri.* ]]; then
      if [[ "${arg}" == *"="* ]]; then
        template_value="${arg#*=}"
      else
        ((i += 1)) # next value should be the path
        eval "template_value=\${$i}"
      fi

      # does it look like a local path?
      if [[ "${template_value}" =~ ^[\./] ]]; then
        abs_path=$(realpath "${template_value}")
        docker_flags+=("-v=${abs_path}:/template-dir:ro")
        processed_args+=("--template-uri=/template-dir")
        continue
      fi
  fi

  # the last argument should be the project path, will need adjusted if/when
  # that's not the case for all commands
  if [[ $i == "$#" ]]; then
    last_arg="${arg}"
    abs_last_arg=$(realpath "${last_arg}")
    docker_flags+=("-v=${abs_last_arg}:/project-dir:z")
    processed_args+=("/project-dir")
    continue
  fi

  processed_args+=("${arg}")
done

docker run --interactive --tty --rm "${docker_flags[@]}" nava-platform-cli "${processed_args[@]}"
